<?php
/**
 * Cocoon Child Theme Functions
 * „Éù„ÉÉ„Éâ„Ç≠„É£„Çπ„Éà„Çµ„Ç§„ÉàÂ∞ÇÁî®„ÅÆ„Ç´„Çπ„Çø„Éû„Ç§„Ç∫
 */

// Áõ¥Êé•„Åì„ÅÆ„Éï„Ç°„Ç§„É´„Å´„Ç¢„ÇØ„Çª„Çπ„Åô„Çã„Åì„Å®„ÇíÈò≤„Åê
if (!defined('ABSPATH')) {
    exit;
}

/**
 * Cocoon„ÅÆ„Éá„Éï„Ç©„É´„Éà„Éò„ÉÉ„ÉÄ„Éº„ÇíÁÑ°ÂäπÂåñ
 */
function contentfreaks_disable_default_header() {
    // Cocoon„ÅÆ„Éò„ÉÉ„ÉÄ„ÉºÈñ¢ÈÄ£„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÂâäÈô§
    remove_action('wp_head', 'cocoon_header_meta');
    remove_action('get_header', 'cocoon_header_init');
    
    // „Éò„ÉÉ„ÉÄ„ÉºÈñ¢ÈÄ£„ÅÆ„Éï„Ç£„É´„Çø„Éº„ÇíÂâäÈô§
    remove_filter('wp_head', 'cocoon_meta_description');
    remove_filter('wp_head', 'cocoon_meta_keywords');
}
add_action('init', 'contentfreaks_disable_default_header', 1);

/**
 * body_class„Å´„Ç´„Çπ„Çø„É†„Éò„ÉÉ„ÉÄ„Éº„ÇØ„É©„Çπ„ÇíËøΩÂä†
 */
function contentfreaks_body_class($classes) {
    $classes[] = 'contentfreaks-custom-header';
    return $classes;
}
add_filter('body_class', 'contentfreaks_body_class');

/**
 * Â≠ê„ÉÜ„Éº„Éû„ÅÆ„Çπ„Çø„Ç§„É´„Å®„Çπ„ÇØ„É™„Éó„Éà„ÇíË™≠„ÅøËæº„Åø
 */
function contentfreaks_enqueue_scripts() {
    // Ë¶™„ÉÜ„Éº„Éû„ÅÆ„Çπ„Çø„Ç§„É´„ÇíË™≠„ÅøËæº„Åø
    wp_enqueue_style('cocoon-style', get_template_directory_uri() . '/style.css');
    
    // Â≠ê„ÉÜ„Éº„Éû„ÅÆ„É°„Ç§„É≥„Çπ„Çø„Ç§„É´ÔºàWordPress„ÅÆÊ®ôÊ∫ñÔºâ
    wp_enqueue_style('contentfreaks-main-style', get_stylesheet_directory_uri() . '/style.css', array('cocoon-style'), '1.1.4');
    
    // ContentFreaksÂ∞ÇÁî®Êã°Âºµ„Çπ„Çø„Ç§„É´ÔºàÈáçË§áÂâäÈô§Ê∏à„Åø„ÉªÊúÄÈÅ©ÂåñÁâàÔºâ
    wp_enqueue_style('contentfreaks-final-style', get_stylesheet_directory_uri() . '/contentfreaks-final.css', array('contentfreaks-main-style'), '1.0.0');
    
    // Â≠ê„ÉÜ„Éº„Éû„ÅÆJavaScript„ÇíË™≠„ÅøËæº„Åø
    wp_enqueue_script('contentfreaks-script', get_stylesheet_directory_uri() . '/javascript.js', array('jquery'), '1.0.0', true);
    
    // AJAXÁî®„ÅÆË®≠ÂÆö„ÇíËøΩÂä†
    wp_localize_script('contentfreaks-script', 'contentfreaks_ajax', array(
        'ajax_url' => admin_url('admin-ajax.php'),
        'nonce' => wp_create_nonce('contentfreaks_ajax_nonce')
    ));
}
add_action('wp_enqueue_scripts', 'contentfreaks_enqueue_scripts');

// „Ç´„Çπ„Çø„É†„Éï„Ç£„Éº„É´„ÉâÊ©üËÉΩ„ÅØÂâäÈô§ÔºöRSS„Åã„ÇâÁõ¥Êé•„Ç®„Éî„ÇΩ„Éº„Éâ„Éá„Éº„Çø„ÇíË°®Á§∫„Åô„Çã„Åü„ÇÅ‰∏çË¶Å

// latest_episode„Ç∑„Éß„Éº„Éà„Ç≥„Éº„Éâ„ÅØÂâäÈô§Ôºöfront-page.php„ÅßÁõ¥Êé•RSSË°®Á§∫„Çí‰ΩøÁî®

/**
 * „Ç∑„Éß„Éº„Éà„Ç≥„Éº„Éâ: „Éù„ÉÉ„Éâ„Ç≠„É£„Çπ„Éà„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†„É™„É≥„ÇØ
 */
function contentfreaks_podcast_platforms_shortcode() {
    $platforms = array(
        'spotify' => array(
            'name' => 'Spotify', 
            'icon' => get_theme_mod('spotify_icon') ? '<img src="' . esc_url(get_theme_mod('spotify_icon')) . '" alt="Spotify" style="width: 24px; height: 24px; object-fit: contain;">' : 'üéß',
            'url' => 'https://open.spotify.com/show/20otj7CiCZ0hcWYkkEpnLL?si=w3Jlrpg5Ssmk0TGa_Flb8g',
            'color' => '#1DB954'
        ),
        'apple' => array(
            'name' => 'Apple Podcasts', 
            'icon' => get_theme_mod('apple_podcasts_icon') ? '<img src="' . esc_url(get_theme_mod('apple_podcasts_icon')) . '" alt="Apple Podcasts" style="width: 24px; height: 24px; object-fit: contain;">' : 'üçé',
            'url' => 'https://podcasts.apple.com/jp/podcast/%E3%82%B3%E3%83%B3%E3%83%86%E3%83%B3%E3%83%84%E3%83%95%E3%83%AA%E3%83%BC%E3%82%AF%E3%82%B9/id1692185758',
            'color' => '#A855F7'
        ),
        'youtube' => array(
            'name' => 'YouTube', 
            'icon' => get_theme_mod('youtube_icon') ? '<img src="' . esc_url(get_theme_mod('youtube_icon')) . '" alt="YouTube" style="width: 24px; height: 24px; object-fit: contain;">' : 'üì∫',
            'url' => 'https://youtube.com/@contentfreaks',
            'color' => '#FF0000'
        ),
    );
    
    ob_start();
    echo '<div class="platforms-grid">';
    
    foreach ($platforms as $key => $platform) {
        echo '<a href="' . esc_url($platform['url']) . '" class="platform-link platform-' . esc_attr($key) . '" target="_blank" rel="noopener">';
        echo '<div class="platform-icon">' . $platform['icon'] . '</div>';
        echo '<div class="platform-name">' . esc_html($platform['name']) . '</div>';
        echo '<div class="platform-action">‰ªä„Åô„ÅêËÅ¥„Åè</div>';
        echo '</a>';
    }
    
    echo '</div>';
    return ob_get_clean();
}
add_shortcode('podcast_platforms', 'contentfreaks_podcast_platforms_shortcode');

/**
 * „Ç∑„Éß„Éº„Éà„Ç≥„Éº„Éâ: „Éõ„Çπ„ÉàÁ¥π‰ªã
 */
function contentfreaks_hosts_shortcode() {
    // „Ç´„Çπ„Çø„Éû„Ç§„Ç∂„Éº„Åã„Çâ2‰∫∫ÂàÜ„ÅÆ„Éõ„Çπ„ÉàÊÉÖÂ†±„ÇíÂèñÂæó
    $host1_name = get_theme_mod('host1_name', '„Éõ„Çπ„Éà1');
    $host1_role = get_theme_mod('host1_role', '„É°„Ç§„É≥„Éõ„Çπ„Éà');
    $host1_bio = get_theme_mod('host1_bio', '„Ç≥„É≥„ÉÜ„É≥„ÉÑÂà∂‰Ωú„Å´„Å§„ÅÑ„Å¶Ë™û„Çä„Åæ„Åô„ÄÇ');
    $host1_image = get_theme_mod('host1_image', '');
    $host1_twitter = get_theme_mod('host1_twitter', '');
    $host1_youtube = get_theme_mod('host1_youtube', '');
    
    $host2_name = get_theme_mod('host2_name', '„Éõ„Çπ„Éà2');
    $host2_role = get_theme_mod('host2_role', '„Ç≥„Éõ„Çπ„Éà');
    $host2_bio = get_theme_mod('host2_bio', '„Ç≥„É≥„ÉÜ„É≥„ÉÑÂà∂‰Ωú„Å´„Å§„ÅÑ„Å¶Ë™û„Çä„Åæ„Åô„ÄÇ');
    $host2_image = get_theme_mod('host2_image', '');
    $host2_twitter = get_theme_mod('host2_twitter', '');
    $host2_youtube = get_theme_mod('host2_youtube', '');
    
    $hosts = array();
    
    // „Éõ„Çπ„Éà1„ÅÆÊÉÖÂ†±„ÇíËøΩÂä†ÔºàÂêçÂâç„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÔºâ
    if (!empty($host1_name) && $host1_name !== '„Éõ„Çπ„Éà1') {
        $host1_social = array();
        if (!empty($host1_twitter)) $host1_social['twitter'] = $host1_twitter;
        if (!empty($host1_youtube)) $host1_social['youtube'] = $host1_youtube;
        
        $hosts[] = array(
            'name' => $host1_name,
            'role' => $host1_role,
            'bio' => $host1_bio,
            'image' => $host1_image,
            'social' => $host1_social
        );
    }
    
    // „Éõ„Çπ„Éà2„ÅÆÊÉÖÂ†±„ÇíËøΩÂä†ÔºàÂêçÂâç„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÔºâ
    if (!empty($host2_name) && $host2_name !== '„Éõ„Çπ„Éà2') {
        $host2_social = array();
        if (!empty($host2_twitter)) $host2_social['twitter'] = $host2_twitter;
        if (!empty($host2_youtube)) $host2_social['youtube'] = $host2_youtube;
        
        $hosts[] = array(
            'name' => $host2_name,
            'role' => $host2_role,
            'bio' => $host2_bio,
            'image' => $host2_image,
            'social' => $host2_social
        );
    }
    
    // „Å©„Å°„Çâ„ÇÇË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„Éá„Éï„Ç©„É´„ÉàË°®Á§∫
    if (empty($hosts)) {
        $hosts = array(
            array(
                'name' => '„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Éï„É™„Éº„ÇØ„Çπ',
                'role' => '„É°„Ç§„É≥„Éõ„Çπ„Éà',
                'bio' => 'YouTuber„ÄÅ„Éñ„É≠„Ç¨„Éº„ÄÅ„Ç§„É≥„Éï„É´„Ç®„É≥„Çµ„Éº„Å™„Å©Êßò„ÄÖ„Å™„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇØ„É™„Ç®„Ç§„Çø„Éº„Çí„Ç≤„Çπ„Éà„Å´Ëøé„Åà„ÄÅÂà∂‰Ωú„ÅÆË£èÂÅ¥„ÇÑÊàêÂäü„ÅÆÁßòË®£„ÇíÊ∑±Êéò„Çä„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ',
                'image' => '',
                'social' => array('twitter' => 'https://twitter.com/contentfreaks', 'youtube' => 'https://youtube.com/@contentfreaks')
            )
        );
    }
    
    ob_start();
    echo '<div class="hosts-grid">';
    
    foreach ($hosts as $host) {
        echo '<div class="host-card">';
        
        if ($host['image']) {
            echo '<div class="host-image"><img src="' . esc_url($host['image']) . '" alt="' . esc_attr($host['name']) . '"></div>';
        } else {
            echo '<div class="host-image" style="background: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 3rem;">üéôÔ∏è</div>';
        }
        
        echo '<div class="host-content">';
        echo '<h3 class="host-name">' . esc_html($host['name']) . '</h3>';
        echo '<div class="host-role">' . esc_html($host['role']) . '</div>';
        echo '<div class="host-bio">' . esc_html($host['bio']) . '</div>';
        
        if (!empty($host['social'])) {
            echo '<div class="host-social">';
            foreach ($host['social'] as $platform => $url) {
                $icon = $platform === 'twitter' ? 'üê¶' : ($platform === 'youtube' ? 'üì∫' : 'üîó');
                echo '<a href="' . esc_url($url) . '" class="social-link" target="_blank" rel="noopener">' . $icon . '</a>';
            }
            echo '</div>';
        }
        
        echo '</div>';
        echo '</div>';
    }
    
    echo '</div>';
    return ob_get_clean();
}
add_shortcode('podcast_hosts', 'contentfreaks_hosts_shortcode');

/**
 * „Ç´„Çπ„Çø„Éû„Ç§„Ç∂„Éº„Å´„Éù„ÉÉ„Éâ„Ç≠„É£„Çπ„ÉàË®≠ÂÆö„ÇíËøΩÂä†
 */
function contentfreaks_customize_register($wp_customize) {
    // „Éù„ÉÉ„Éâ„Ç≠„É£„Çπ„ÉàË®≠ÂÆö„Çª„ÇØ„Ç∑„Éß„É≥
    $wp_customize->add_section('contentfreaks_podcast_settings', array(
        'title' => '„Éù„ÉÉ„Éâ„Ç≠„É£„Çπ„ÉàË®≠ÂÆö',
        'priority' => 30,
    ));
    
    // „Éù„ÉÉ„Éâ„Ç≠„É£„Çπ„ÉàÂêç
    $wp_customize->add_setting('podcast_name', array(
        'default' => '„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Éï„É™„Éº„ÇØ„Çπ',
        'sanitize_callback' => 'sanitize_text_field',
    ));
    
    $wp_customize->add_control('podcast_name', array(
        'label' => '„Éù„ÉÉ„Éâ„Ç≠„É£„Çπ„ÉàÂêç',
        'section' => 'contentfreaks_podcast_settings',
        'type' => 'text',
    ));
    
    // „Éù„ÉÉ„Éâ„Ç≠„É£„Çπ„ÉàË™¨Êòé
    $wp_customize->add_setting('podcast_description', array(
        'default' => '',
        'sanitize_callback' => 'sanitize_textarea_field',
    ));
    
    $wp_customize->add_control('podcast_description', array(
        'label' => '„Éù„ÉÉ„Éâ„Ç≠„É£„Çπ„ÉàË™¨Êòé',
        'section' => 'contentfreaks_podcast_settings',
        'type' => 'textarea',
    ));
    
    // „Éù„ÉÉ„Éâ„Ç≠„É£„Çπ„Éà„Ç¢„Éº„Éà„ÉØ„Éº„ÇØ
    $wp_customize->add_setting('podcast_artwork', array(
        'default' => '',
        'sanitize_callback' => 'esc_url_raw',
    ));
    
    $wp_customize->add_control(new WP_Customize_Image_Control($wp_customize, 'podcast_artwork', array(
        'label' => '„Éù„ÉÉ„Éâ„Ç≠„É£„Çπ„Éà„Ç¢„Éº„Éà„ÉØ„Éº„ÇØ',
        'section' => 'contentfreaks_podcast_settings',
    )));
    
    // „Éõ„Çπ„Éà1Ë®≠ÂÆö
    $wp_customize->add_setting('host1_name', array(
        'default' => '',
        'sanitize_callback' => 'sanitize_text_field',
    ));
    
    $wp_customize->add_control('host1_name', array(
        'label' => '„Éõ„Çπ„Éà1 ÂêçÂâç',
        'section' => 'contentfreaks_podcast_settings',
        'type' => 'text',
    ));
    
    $wp_customize->add_setting('host1_role', array(
        'default' => '„É°„Ç§„É≥„Éõ„Çπ„Éà',
        'sanitize_callback' => 'sanitize_text_field',
    ));
    
    $wp_customize->add_control('host1_role', array(
        'label' => '„Éõ„Çπ„Éà1 ÂΩπËÅ∑',
        'section' => 'contentfreaks_podcast_settings',
        'type' => 'text',
    ));
    
    $wp_customize->add_setting('host1_bio', array(
        'default' => '',
        'sanitize_callback' => 'sanitize_textarea_field',
    ));
    
    $wp_customize->add_control('host1_bio', array(
        'label' => '„Éõ„Çπ„Éà1 Á¥π‰ªãÊñá',
        'section' => 'contentfreaks_podcast_settings',
        'type' => 'textarea',
    ));
    
    $wp_customize->add_setting('host1_image', array(
        'default' => '',
        'sanitize_callback' => 'esc_url_raw',
    ));
    
    $wp_customize->add_control(new WP_Customize_Image_Control($wp_customize, 'host1_image', array(
        'label' => '„Éõ„Çπ„Éà1 ÁîªÂÉè',
        'section' => 'contentfreaks_podcast_settings',
    )));
    
    $wp_customize->add_setting('host1_twitter', array(
        'default' => '',
        'sanitize_callback' => 'esc_url_raw',
    ));
    
    $wp_customize->add_control('host1_twitter', array(
        'label' => '„Éõ„Çπ„Éà1 Twitter URL',
        'section' => 'contentfreaks_podcast_settings',
        'type' => 'url',
    ));
    
    $wp_customize->add_setting('host1_youtube', array(
        'default' => '',
        'sanitize_callback' => 'esc_url_raw',
    ));
    
    $wp_customize->add_control('host1_youtube', array(
        'label' => '„Éõ„Çπ„Éà1 YouTube URL',
        'section' => 'contentfreaks_podcast_settings',
        'type' => 'url',
    ));
    
    // „Éõ„Çπ„Éà2Ë®≠ÂÆö
    $wp_customize->add_setting('host2_name', array(
        'default' => '',
        'sanitize_callback' => 'sanitize_text_field',
    ));
    
    $wp_customize->add_control('host2_name', array(
        'label' => '„Éõ„Çπ„Éà2 ÂêçÂâç',
        'section' => 'contentfreaks_podcast_settings',
        'type' => 'text',
    ));
    
    $wp_customize->add_setting('host2_role', array(
        'default' => '„Ç≥„Éõ„Çπ„Éà',
        'sanitize_callback' => 'sanitize_text_field',
    ));
    
    $wp_customize->add_control('host2_role', array(
        'label' => '„Éõ„Çπ„Éà2 ÂΩπËÅ∑',
        'section' => 'contentfreaks_podcast_settings',
        'type' => 'text',
    ));
    
    $wp_customize->add_setting('host2_bio', array(
        'default' => '',
        'sanitize_callback' => 'sanitize_textarea_field',
    ));
    
    $wp_customize->add_control('host2_bio', array(
        'label' => '„Éõ„Çπ„Éà2 Á¥π‰ªãÊñá',
        'section' => 'contentfreaks_podcast_settings',
        'type' => 'textarea',
    ));
    
    $wp_customize->add_setting('host2_image', array(
        'default' => '',
        'sanitize_callback' => 'esc_url_raw',
    ));
    
    $wp_customize->add_control(new WP_Customize_Image_Control($wp_customize, 'host2_image', array(
        'label' => '„Éõ„Çπ„Éà2 ÁîªÂÉè',
        'section' => 'contentfreaks_podcast_settings',
    )));
    
    $wp_customize->add_setting('host2_twitter', array(
        'default' => '',
        'sanitize_callback' => 'esc_url_raw',
    ));
    
    $wp_customize->add_control('host2_twitter', array(
        'label' => '„Éõ„Çπ„Éà2 Twitter URL',
        'section' => 'contentfreaks_podcast_settings',
        'type' => 'url',
    ));
    
    $wp_customize->add_setting('host2_youtube', array(
        'default' => '',
        'sanitize_callback' => 'esc_url_raw',
    ));
    
    $wp_customize->add_control('host2_youtube', array(
        'label' => '„Éõ„Çπ„Éà2 YouTube URL',
        'section' => 'contentfreaks_podcast_settings',
        'type' => 'url',
    ));
    
    // „Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†„Ç¢„Ç§„Ç≥„É≥Ë®≠ÂÆö
    $wp_customize->add_setting('spotify_icon', array(
        'default' => '',
        'sanitize_callback' => 'esc_url_raw',
    ));
    
    $wp_customize->add_control(new WP_Customize_Image_Control($wp_customize, 'spotify_icon', array(
        'label' => 'Spotify „Ç¢„Ç§„Ç≥„É≥ÁîªÂÉè',
        'section' => 'contentfreaks_podcast_settings',
        'description' => 'Spotify„Ç¢„Ç§„Ç≥„É≥Áî®„ÅÆÁîªÂÉè„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàÁ©∫„ÅÆÂ†¥Âêà„ÅØ„Éá„Éï„Ç©„É´„ÉàÁµµÊñáÂ≠ó üéß „Çí‰ΩøÁî®Ôºâ',
    )));
    
    $wp_customize->add_setting('apple_podcasts_icon', array(
        'default' => '',
        'sanitize_callback' => 'esc_url_raw',
    ));
    
    $wp_customize->add_control(new WP_Customize_Image_Control($wp_customize, 'apple_podcasts_icon', array(
        'label' => 'Apple Podcasts „Ç¢„Ç§„Ç≥„É≥ÁîªÂÉè',
        'section' => 'contentfreaks_podcast_settings',
        'description' => 'Apple Podcasts„Ç¢„Ç§„Ç≥„É≥Áî®„ÅÆÁîªÂÉè„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàÁ©∫„ÅÆÂ†¥Âêà„ÅØ„Éá„Éï„Ç©„É´„ÉàÁµµÊñáÂ≠ó üçé „Çí‰ΩøÁî®Ôºâ',
    )));
    
    $wp_customize->add_setting('youtube_icon', array(
        'default' => '',
        'sanitize_callback' => 'esc_url_raw',
    ));
    
    $wp_customize->add_control(new WP_Customize_Image_Control($wp_customize, 'youtube_icon', array(
        'label' => 'YouTube „Ç¢„Ç§„Ç≥„É≥ÁîªÂÉè',
        'section' => 'contentfreaks_podcast_settings',
        'description' => 'YouTube„Ç¢„Ç§„Ç≥„É≥Áî®„ÅÆÁîªÂÉè„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàÁ©∫„ÅÆÂ†¥Âêà„ÅØ„Éá„Éï„Ç©„É´„ÉàÁµµÊñáÂ≠ó üì∫ „Çí‰ΩøÁî®Ôºâ',
    )));
}
add_action('customize_register', 'contentfreaks_customize_register');

/**
 * RSS„Ç®„Éî„ÇΩ„Éº„Éâ„ÇíÊäïÁ®ø„Å®„Åó„Å¶Ëá™Âãï‰ΩúÊàê
 */
function contentfreaks_sync_rss_to_posts() {
    $episodes = contentfreaks_get_rss_episodes(0); // ÂÖ®„Ç®„Éî„ÇΩ„Éº„ÉâÂèñÂæó
    $synced_count = 0;
    $errors = array();
    
    // „Éù„ÉÉ„Éâ„Ç≠„É£„Çπ„Éà„Ç´„ÉÜ„Ç¥„É™„Éº„Çí‰ΩúÊàêÔºàÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥ÂêàÔºâ
    $podcast_category = get_category_by_slug('podcast');
    if (!$podcast_category) {
        $cat_id = wp_create_category('„Éù„ÉÉ„Éâ„Ç≠„É£„Çπ„Éà');
        $podcast_category = get_category($cat_id);
    }
    
    foreach ($episodes as $episode) {
        // Êó¢Â≠òÊäïÁ®ø„ÉÅ„Çß„ÉÉ„ÇØÔºà„Çø„Ç§„Éà„É´„ÅßÈáçË§áÁ¢∫Ë™çÔºâ
        $existing_post = get_posts(array(
            'title' => $episode['title'],
            'post_type' => 'post',
            'post_status' => array('publish', 'draft', 'private'),
            'numberposts' => 1
        ));
        
        if (empty($existing_post)) {
            // Êñ∞Ë¶èÊäïÁ®ø‰ΩúÊàê
            $post_data = array(
                'post_title' => $episode['title'],
                'post_content' => $episode['full_description'],
                'post_excerpt' => $episode['description'],
                'post_status' => 'publish',
                'post_date' => $episode['pub_date'],
                'post_category' => array($podcast_category->term_id),
                'post_type' => 'post'
            );
            
            $post_id = wp_insert_post($post_data);
            
            if (!is_wp_error($post_id) && $post_id > 0) {
                // „Ç´„Çπ„Çø„É†„Éï„Ç£„Éº„É´„Éâ‰øùÂ≠ò
                update_post_meta($post_id, 'episode_audio_url', $episode['audio_url']);
                update_post_meta($post_id, 'episode_number', $episode['episode_number']);
                update_post_meta($post_id, 'episode_duration', $episode['duration']);
                update_post_meta($post_id, 'episode_original_url', $episode['link']);
                update_post_meta($post_id, 'episode_category', $episode['category']);
                update_post_meta($post_id, 'is_podcast_episode', '1');
                
                // „Ç¢„Ç§„Ç≠„É£„ÉÉ„ÉÅÁîªÂÉèË®≠ÂÆö
                if ($episode['thumbnail']) {
                    contentfreaks_set_featured_image_from_url($post_id, $episode['thumbnail']);
                }
                
                $synced_count++;
            } else {
                $errors[] = 'ÊäïÁ®ø‰ΩúÊàê„Ç®„É©„Éº: ' . $episode['title'];
            }
        }
    }
    
    // ÂêåÊúüÁµêÊûú„Çí‰øùÂ≠ò
    update_option('contentfreaks_last_sync_time', current_time('mysql'));
    update_option('contentfreaks_last_sync_count', $synced_count);
    update_option('contentfreaks_last_sync_errors', $errors);
    
    return array(
        'synced' => $synced_count,
        'errors' => $errors
    );
}

/**
 * Â§ñÈÉ®URL„Åã„Çâ„Ç¢„Ç§„Ç≠„É£„ÉÉ„ÉÅÁîªÂÉè„ÇíË®≠ÂÆö
 */
function contentfreaks_set_featured_image_from_url($post_id, $image_url) {
    // Êó¢„Å´„Ç¢„Ç§„Ç≠„É£„ÉÉ„ÉÅÁîªÂÉè„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
    if (has_post_thumbnail($post_id)) {
        return;
    }
    
    // media_sideload_imageÈñ¢Êï∞„Çí‰ΩøÁî®„Åô„Çã„Åü„ÇÅ„Å´ÂøÖË¶Å„Å™„Éï„Ç°„Ç§„É´„Çí„Ç§„É≥„ÇØ„É´„Éº„Éâ
    if (!function_exists('media_sideload_image')) {
        require_once(ABSPATH . 'wp-admin/includes/media.php');
        require_once(ABSPATH . 'wp-admin/includes/file.php');
        require_once(ABSPATH . 'wp-admin/includes/image.php');
    }
    
    // URL „Åã„ÇâÁîªÂÉè„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Å¶„É°„Éá„Ç£„Ç¢„É©„Ç§„Éñ„É©„É™„Å´ËøΩÂä†
    $image_id = media_sideload_image($image_url, $post_id, null, 'id');
    
    if (!is_wp_error($image_id)) {
        set_post_thumbnail($post_id, $image_id);
        return true;
    } else {
        // „Ç®„É©„Éº„É≠„Ç∞„Å´Ë®òÈå≤
        error_log('„Çµ„É†„Éç„Ç§„É´Ë®≠ÂÆö„Ç®„É©„Éº (Post ID: ' . $post_id . '): ' . $image_id->get_error_message());
        return false;
    }
}

/**
 * ÂÆöÊúüÂêåÊúü„Çπ„Ç±„Ç∏„É•„Éº„É´
 */
function contentfreaks_schedule_sync() {
    if (!wp_next_scheduled('contentfreaks_hourly_sync')) {
        wp_schedule_event(time(), 'hourly', 'contentfreaks_hourly_sync');
    }
}
add_action('wp', 'contentfreaks_schedule_sync');

add_action('contentfreaks_hourly_sync', 'contentfreaks_sync_rss_to_posts');

/**
 * ÁÆ°ÁêÜÁîªÈù¢„É°„Éã„É•„Éº
 */
function contentfreaks_admin_menu() {
    add_management_page(
        '„Éù„ÉÉ„Éâ„Ç≠„É£„Çπ„ÉàÁÆ°ÁêÜ',
        '„Éù„ÉÉ„Éâ„Ç≠„É£„Çπ„ÉàÁÆ°ÁêÜ', 
        'manage_options',
        'contentfreaks-sync',
        'contentfreaks_sync_admin_page'
    );
}
add_action('admin_menu', 'contentfreaks_admin_menu');

/**
 * RSS„Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢Ê©üËÉΩ
 */
function contentfreaks_clear_rss_cache() {
    // ÁèæÂú®‰ΩøÁî®‰∏≠„ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•„ÅÆ„Åø„ÇØ„É™„Ç¢
    delete_transient('contentfreaks_rss_episodes_1');
    delete_transient('contentfreaks_rss_episodes_6');
    delete_transient('contentfreaks_rss_episodes_all');
    delete_transient('contentfreaks_rss_count');
    
    // Âè§„ÅÑÂêåÊúüÈñ¢ÈÄ£„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥„ÇÇÂâäÈô§
    delete_option('contentfreaks_last_rss_sync');
    delete_option('contentfreaks_last_sync_count');
    delete_option('contentfreaks_last_sync_error');
    
    return true;
}

/**
 * ÁÆ°ÁêÜÁîªÈù¢„ÅÆÂêåÊúü„Éö„Éº„Ç∏
 */
function contentfreaks_sync_admin_page() {
    // ÊâãÂãïÂêåÊúüÂá¶ÁêÜ
    if (isset($_POST['manual_sync']) && wp_verify_nonce($_POST['sync_nonce'], 'contentfreaks_sync')) {
        $result = contentfreaks_sync_rss_to_posts();
        if (!empty($result['errors'])) {
            echo '<div class="notice notice-warning"><p>' . $result['synced'] . ' ‰ª∂„ÅÆ„Ç®„Éî„ÇΩ„Éº„Éâ„ÇíÂêåÊúü„Åó„Åæ„Åó„Åü„ÄÇ„Ç®„É©„Éº: ' . count($result['errors']) . ' ‰ª∂</p></div>';
        } else {
            echo '<div class="notice notice-success"><p>' . $result['synced'] . ' ‰ª∂„ÅÆ„Ç®„Éî„ÇΩ„Éº„Éâ„ÇíÂêåÊúü„Åó„Åæ„Åó„ÅüÔºÅ</p></div>';
        }
    }

    // „Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢Âá¶ÁêÜ
    if (isset($_POST['clear_cache']) && wp_verify_nonce($_POST['clear_cache_nonce'], 'contentfreaks_clear_cache')) {
        contentfreaks_clear_rss_cache();
        echo '<div class="notice notice-success"><p>RSS„Ç≠„É£„ÉÉ„Ç∑„É•„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„ÅüÔºÅ</p></div>';
    }

    // RSS„ÉÜ„Çπ„ÉàÂá¶ÁêÜ
    if (isset($_POST['test_rss']) && wp_verify_nonce($_POST['test_rss_nonce'], 'contentfreaks_test_rss')) {
        echo '<div class="notice notice-info">';
        echo '<h3>RSS„Éï„Ç£„Éº„Éâ„ÉÜ„Çπ„ÉàÁµêÊûú</h3>';
        
        // „Ç≠„É£„ÉÉ„Ç∑„É•„Çí„ÇØ„É™„Ç¢„Åó„Å¶„Åã„ÇâÊñ∞Ë¶èÂèñÂæó
        contentfreaks_clear_rss_cache();
        $episodes = contentfreaks_get_rss_episodes(5);
        
        if (!empty($episodes)) {
            echo '<p style="color: green;">‚úÖ RSSÂèñÂæóÊàêÂäüÔºÅ ' . count($episodes) . ' ‰ª∂„ÅÆ„Ç®„Éî„ÇΩ„Éº„Éâ„ÇíÂèñÂæó</p>';
            echo '<ul>';
            foreach ($episodes as $episode) {
                echo '<li>';
                echo '<strong>' . esc_html($episode['title']) . '</strong><br>';
                echo 'Êó•‰ªò: ' . esc_html($episode['formatted_date']) . '<br>';
                echo 'Èü≥Â£∞URL: ' . ($episode['audio_url'] ? '‚úÖ „ÅÇ„Çä' : '‚ùå „Å™„Åó') . '<br>';
                echo 'ÂÜçÁîüÊôÇÈñì: ' . ($episode['duration'] ? esc_html($episode['duration']) : '‰∏çÊòé') . '<br>';
                echo '</li><hr>';
            }
            echo '</ul>';
        } else {
            echo '<p style="color: red;">‚ùå „Ç®„É©„Éº: „Ç®„Éî„ÇΩ„Éº„Éâ„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü</p>';
        }
        echo '</div>';
    }
    
    // ÁèæÂú®„ÅÆÁµ±Ë®àÊÉÖÂ†±„ÇíÂèñÂæó
    $current_rss_count = contentfreaks_get_rss_episode_count();
    $post_count = wp_count_posts()->publish;
    $podcast_posts = get_posts(array(
        'meta_key' => 'is_podcast_episode',
        'meta_value' => '1',
        'post_status' => 'publish',
        'numberposts' => -1
    ));
    $podcast_post_count = count($podcast_posts);
    $last_sync_time = get_option('contentfreaks_last_sync_time', 'Êú™ÂêåÊúü');
    $last_sync_count = get_option('contentfreaks_last_sync_count', 0);
    
    echo '<div class="wrap">';
    echo '<h1>„Éù„ÉÉ„Éâ„Ç≠„É£„Çπ„ÉàÁÆ°ÁêÜ</h1>';
    echo '<p>RSS„Éï„Ç£„Éº„Éâ„Åã„Çâ„Ç®„Éî„ÇΩ„Éº„Éâ„ÇíÊäïÁ®ø„Å®„Åó„Å¶Ëá™ÂãïÂêåÊúü„Åó„Åæ„Åô„ÄÇ</p>';
    
    echo '<div style="background: white; padding: 20px; border: 1px solid #ddd; margin-bottom: 20px;">';
    echo '<h3>üìä Áµ±Ë®àÊÉÖÂ†±</h3>';
    echo '<p><strong>RSS„Ç®„Éî„ÇΩ„Éº„ÉâÊï∞:</strong> ' . $current_rss_count . ' ‰ª∂</p>';
    echo '<p><strong>WordPressÊäïÁ®øÊï∞:</strong> ' . $post_count . ' ‰ª∂</p>';
    echo '<p><strong>„Éù„ÉÉ„Éâ„Ç≠„É£„Çπ„ÉàÊäïÁ®øÊï∞:</strong> ' . $podcast_post_count . ' ‰ª∂</p>';
    echo '<p><strong>ÊúÄÁµÇÂêåÊúü:</strong> ' . $last_sync_time . '</p>';
    echo '<p><strong>ÂâçÂõûÂêåÊúüÊï∞:</strong> ' . $last_sync_count . ' ‰ª∂</p>';
    echo '</div>';
    
    echo '<div style="display: flex; gap: 10px; margin-bottom: 20px;">';
    
    // ÊâãÂãïÂêåÊúü„Éú„Çø„É≥
    echo '<form method="post" style="display: inline;">';
    wp_nonce_field('contentfreaks_sync', 'sync_nonce');
    echo '<input type="submit" name="manual_sync" class="button-primary" value="ÊâãÂãïÂêåÊúüÂÆüË°å" />';
    echo '</form>';
    
    // „Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢„Éú„Çø„É≥
    echo '<form method="post" style="display: inline;">';
    wp_nonce_field('contentfreaks_clear_cache', 'clear_cache_nonce');
    echo '<input type="submit" name="clear_cache" class="button-secondary" value="RSS„Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢" />';
    echo '</form>';
    
    // RSS„ÉÜ„Çπ„Éà„Éú„Çø„É≥
    echo '<form method="post" style="display: inline;">';
    wp_nonce_field('contentfreaks_test_rss', 'test_rss_nonce');
    echo '<input type="submit" name="test_rss" class="button-secondary" value="RSSÊé•Á∂ö„ÉÜ„Çπ„Éà" />';
    echo '</form>';
    
    echo '</div>';
    
    echo '<div style="background: #f9f9f9; padding: 15px; border-left: 4px solid #0073aa;">';
    echo '<h4>‚ÑπÔ∏è ÊÉÖÂ†±</h4>';
    echo '<p><strong>RSS URL:</strong> https://anchor.fm/s/d8cfdc48/podcast/rss</p>';
    echo '<p><strong>ÂêåÊúü„Çπ„Ç±„Ç∏„É•„Éº„É´:</strong> 1ÊôÇÈñìÊØé„ÅÆËá™ÂãïÂêåÊúü</p>';
    echo '<p><strong>„É°„É™„ÉÉ„Éà:</strong> SEOÂäπÊûú„ÄÅ„Çµ„Ç§„ÉàÂÜÖÊ§úÁ¥¢ÂØæÂøú„ÄÅ„Ç≥„É°„É≥„ÉàÊ©üËÉΩ</p>';
    echo '<p><strong>„Ç®„Éî„ÇΩ„Éº„Éâ‰∏ÄË¶ß:</strong> <a href="' . home_url('/episodes/') . '" target="_blank">„Ç®„Éî„ÇΩ„Éº„Éâ‰∏ÄË¶ß„Éö„Éº„Ç∏</a></p>';
    echo '</div>';
    
    echo '</div>';
}

/**
 * RSS„Åã„ÇâÁõ¥Êé•„Ç®„Éî„ÇΩ„Éº„Éâ„Éá„Éº„Çø„ÇíÂèñÂæóÔºà„Ç≠„É£„ÉÉ„Ç∑„É•Ê©üËÉΩ‰ªò„ÅçÔºâ
 */
function contentfreaks_get_rss_episodes($limit = 0) {
    $spotify_rss_url = 'https://anchor.fm/s/d8cfdc48/podcast/rss';
    
    // „Ç≠„É£„ÉÉ„Ç∑„É•„Ç≠„ÉºÔºà0„ÅØÂÖ®‰ª∂ÂèñÂæó„ÇíÊÑèÂë≥„Åô„ÇãÔºâ
    $cache_key = $limit > 0 ? 'contentfreaks_rss_episodes_' . $limit : 'contentfreaks_rss_episodes_all';
    $cached_data = get_transient($cache_key);
    
    if ($cached_data !== false) {
        return $cached_data;
    }
    
    $feed = fetch_feed($spotify_rss_url);
    
    if (is_wp_error($feed)) {
        error_log('RSSÂèñÂæó„Ç®„É©„Éº: ' . $feed->get_error_message());
        return array();
    }
    
    // 0„ÇíÊåáÂÆö„Åô„Çã„Å®ÂÖ®‰ª∂ÂèñÂæó
    $items = $limit > 0 ? $feed->get_items(0, $limit) : $feed->get_items();
    $episodes = array();
    
    if (empty($items)) {
        error_log('RSS„Éï„Ç£„Éº„Éâ„Å´„Ç¢„Ç§„ÉÜ„É†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
        return array();
    }
    
    foreach ($items as $item) {
        $title = $item->get_title();
        $description = $item->get_description();
        $pub_date = $item->get_date('Y-m-d H:i:s');
        $link = $item->get_link();
        
        // Èü≥Â£∞„Éï„Ç°„Ç§„É´URLÂèñÂæó
        $audio_url = '';
        $enclosure = $item->get_enclosure();
        if ($enclosure) {
            $original_url = $enclosure->get_link();
            if ($original_url) {
                // Anchor.fm URL„ÇíCloudFront URL„Å´Â§âÊèõ
                if (strpos($original_url, 'anchor.fm') !== false) {
                    $audio_url = str_replace('https://anchor.fm/s/d8cfdc48/podcast/play/', 'https://d3ctxlq1ktw2nl.cloudfront.net/', $original_url);
                    $audio_url = str_replace('/play/', '/', $audio_url);
                } else {
                    $audio_url = $original_url;
                }
            }
        }
        
        // „Ç®„Éî„ÇΩ„Éº„ÉâÁï™Âè∑„ÇíÊäΩÂá∫
        $episode_number = '';
        if (preg_match('/[#ÔºÉ](\d+)/', $title, $matches)) {
            $episode_number = $matches[1];
        }
        
        // ÂÜçÁîüÊôÇÈñì„ÇíÊäΩÂá∫
        $duration = '';
        if ($enclosure && method_exists($enclosure, 'get_duration')) {
            $duration_seconds = $enclosure->get_duration();
            if ($duration_seconds) {
                $minutes = floor($duration_seconds / 60);
                $seconds = $duration_seconds % 60;
                $duration = sprintf('%d:%02d', $minutes, $seconds);
            }
        }
        
        // „Ç´„ÉÜ„Ç¥„É™„Éº„ÇíÊäΩÂá∫ÔºàÁ∞°Âçò„Å™ÂàÜÈ°ûÔºâ
        $category = '„Ç®„Éî„ÇΩ„Éº„Éâ';
        if (strpos(strtolower($title), 'special') !== false || strpos($title, '„Çπ„Éö„Ç∑„É£„É´') !== false) {
            $category = '„Çπ„Éö„Ç∑„É£„É´';
        }
        
        // „Çµ„É†„Éç„Ç§„É´ÁîªÂÉè
        $thumbnail = '';
        // iTunes„Çø„Ç∞„Åã„Çâ„Çµ„É†„Éç„Ç§„É´„ÇíÂèñÂæó
        if (method_exists($item, 'get_item_tags')) {
            $item_tags = $item->get_item_tags('http://www.itunes.com/dtds/podcast-1.0.dtd', 'image');
            if (!empty($item_tags[0]['attribs']['']['href'])) {
                $thumbnail = $item_tags[0]['attribs']['']['href'];
            }
        }
        
        // iTunes„Çø„Ç∞„ÅßË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÄÅ‰ªñ„ÅÆÊñπÊ≥ï„Åß„Çµ„É†„Éç„Ç§„É´„ÇíÊé¢„Åô
        if (empty($thumbnail)) {
            // „É°„Éá„Ç£„Ç¢Ë¶ÅÁ¥†„ÅÆ„Çµ„É†„Éç„Ç§„É´„ÇíÊ§úÁ¥¢
            $enclosure = $item->get_enclosure();
            if ($enclosure && method_exists($enclosure, 'get_thumbnail')) {
                $thumbnail = $enclosure->get_thumbnail();
            }
        }
        
        // „Åæ„Å†Ë¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÄÅdescription„Åã„Çâimg src„ÇíÊäΩÂá∫
        if (empty($thumbnail)) {
            if (preg_match('/<img[^>]+src=["\']([^"\']+)["\'][^>]*>/i', $description, $matches)) {
                $thumbnail = $matches[1];
            }
        }
        
        $episodes[] = array(
            'title' => $title,
            'description' => wp_trim_words(strip_tags($description), 30),
            'full_description' => $description,
            'pub_date' => $pub_date,
            'formatted_date' => date('YÂπ¥nÊúàjÊó•', strtotime($pub_date)),
            'link' => $link,
            'audio_url' => $audio_url,
            'episode_number' => $episode_number,
            'duration' => $duration,
            'category' => $category,
            'thumbnail' => $thumbnail
        );
    }
    
    // 30ÂàÜÈñì„Ç≠„É£„ÉÉ„Ç∑„É•
    set_transient($cache_key, $episodes, 30 * MINUTE_IN_SECONDS);
    
    return $episodes;
}

/**
 * RSS„Ç®„Éî„ÇΩ„Éº„ÉâÊï∞„ÇíÂèñÂæó
 */
function contentfreaks_get_rss_episode_count() {
    $cache_key = 'contentfreaks_rss_count';
    $cached_count = get_transient($cache_key);
    
    if ($cached_count !== false) {
        return $cached_count;
    }
    
    $spotify_rss_url = 'https://anchor.fm/s/d8cfdc48/podcast/rss';
    $feed = fetch_feed($spotify_rss_url);
    
    if (is_wp_error($feed)) {
        return 0;
    }
    
    // ÂÖ®„Ç®„Éî„ÇΩ„Éº„Éâ„ÇíÂèñÂæó„Åó„Å¶„Ç´„Ç¶„É≥„Éà
    $items = $feed->get_items();
    $count = count($items);
    
    // 1ÊôÇÈñì„Ç≠„É£„ÉÉ„Ç∑„É•
    set_transient($cache_key, $count, HOUR_IN_SECONDS);
    
    return $count;
}

/**
 * AJAX: „Éù„ÉÉ„Éâ„Ç≠„É£„Çπ„ÉàÊäïÁ®ø„ÅÆËøΩÂä†Ë™≠„ÅøËæº„Åø
 */
function contentfreaks_load_more_podcast_episodes() {
    check_ajax_referer('contentfreaks_ajax_nonce', 'nonce');
    
    $offset = intval($_POST['offset']);
    $limit = intval($_POST['limit']);
    
    $episodes_query = new WP_Query(array(
        'post_type' => 'post',
        'posts_per_page' => $limit,
        'offset' => $offset,
        'meta_key' => 'is_podcast_episode',
        'meta_value' => '1',
        'orderby' => 'date',
        'order' => 'DESC'
    ));

    if (!$episodes_query->have_posts()) {
        wp_die('no_more_episodes');
    }
    
    ob_start();
    while ($episodes_query->have_posts()) : $episodes_query->the_post();
        // „Ç´„Çπ„Çø„É†„Éï„Ç£„Éº„É´„Éâ„ÇíÂèñÂæó
        $audio_url = get_post_meta(get_the_ID(), 'episode_audio_url', true);
        $episode_number = get_post_meta(get_the_ID(), 'episode_number', true);
        $duration = get_post_meta(get_the_ID(), 'episode_duration', true);
        $original_url = get_post_meta(get_the_ID(), 'episode_original_url', true);
        $episode_category = get_post_meta(get_the_ID(), 'episode_category', true) ?: '„Ç®„Éî„ÇΩ„Éº„Éâ';
?>
        <article class="episode-card" data-category="<?php echo esc_attr($episode_category); ?>">
            <div class="episode-thumbnail">
                <?php if (has_post_thumbnail()) : ?>
                    <?php the_post_thumbnail('medium', array('alt' => get_the_title())); ?>
                <?php else : ?>
                    <div style="background: linear-gradient(135deg, #f7ff0b, #ff6b35); width: 100%; height: 200px; display: flex; align-items: center; justify-content: center; font-size: 2rem;">üéôÔ∏è</div>
                <?php endif; ?>
                
                <?php if ($episode_number) : ?>
                <div class="episode-number">EP.<?php echo esc_html($episode_number); ?></div>
                <?php endif; ?>
                
                <?php if ($duration) : ?>
                <div class="episode-duration-badge"><?php echo esc_html($duration); ?></div>
                <?php endif; ?>
                
                <?php if ($audio_url) : ?>
                <div class="episode-play-overlay" data-audio="<?php echo esc_url($audio_url); ?>">‚ñ∂</div>
                <?php endif; ?>
            </div>
            
            <div class="episode-content">
                <div class="episode-date"><?php echo get_the_date('YÂπ¥nÊúàjÊó•'); ?></div>
                <h3 class="episode-title">
                    <a href="<?php the_permalink(); ?>"><?php the_title(); ?></a>
                </h3>
                
                <div class="episode-description">
                    <?php echo wp_trim_words(get_the_excerpt(), 30); ?>
                </div>
                
                <div class="episode-actions">
                    <?php if ($audio_url) : ?>
                    <button class="play-button" data-audio="<?php echo esc_url($audio_url); ?>">
                        ‚ñ∂ ÂÜçÁîü
                    </button>
                    <?php endif; ?>
                    <a href="<?php the_permalink(); ?>" class="read-more-btn">Ë©≥Á¥∞</a>
                    <div class="episode-platforms">
                        <a href="https://open.spotify.com/show/20otj7CiCZ0hcWYkkEpnLL" class="mini-platform-link spotify" target="_blank" title="Spotify„ÅßËÅ¥„Åè"><?php echo get_theme_mod('spotify_icon') ? '<img src="' . esc_url(get_theme_mod('spotify_icon')) . '" alt="Spotify" style="width: 16px; height: 16px; object-fit: contain;">' : 'üéß'; ?></a>
                        <a href="https://podcasts.apple.com/jp/podcast/%E3%82%B3%E3%83%B3%E3%83%86%E3%83%B3%E3%83%84%E3%83%95%E3%83%AA%E3%83%BC%E3%82%AF%E3%82%B9/id1692185758" class="mini-platform-link apple" target="_blank" title="Apple Podcasts„ÅßËÅ¥„Åè"><?php echo get_theme_mod('apple_podcasts_icon') ? '<img src="' . esc_url(get_theme_mod('apple_podcasts_icon')) . '" alt="Apple Podcasts" style="width: 16px; height: 16px; object-fit: contain;">' : 'üçé'; ?></a>
                        <a href="https://youtube.com/@contentfreaks" class="mini-platform-link youtube" target="_blank" title="YouTube„ÅßËÅ¥„Åè"><?php echo get_theme_mod('youtube_icon') ? '<img src="' . esc_url(get_theme_mod('youtube_icon')) . '" alt="YouTube" style="width: 16px; height: 16px; object-fit: contain;">' : 'üì∫'; ?></a>
                    </div>
                </div>
            </div>
        </article>
<?php 
    endwhile;
    wp_reset_postdata();
    
    echo ob_get_clean();
    wp_die();
}
add_action('wp_ajax_load_more_podcast_episodes', 'contentfreaks_load_more_podcast_episodes');
add_action('wp_ajax_nopriv_load_more_podcast_episodes', 'contentfreaks_load_more_podcast_episodes');

/**
 * WordPress„É°„Éã„É•„Éº„ÅÆÁôªÈå≤
 */
function contentfreaks_register_menus() {
    register_nav_menus(array(
        'primary' => '„Éó„É©„Ç§„Éû„É™„É°„Éã„É•„ÉºÔºà„Éò„ÉÉ„ÉÄ„ÉºÔºâ',
        'footer' => '„Éï„ÉÉ„Çø„Éº„É°„Éã„É•„Éº',
    ));
}
add_action('init', 'contentfreaks_register_menus');

/**
 * ContentFreaksÂ∞ÇÁî®„ÅÆbody_class„ÇíËøΩÂä†
 */
function contentfreaks_body_classes($classes) {
    $classes[] = 'contentfreaks-theme';
    $classes[] = 'has-contentfreaks-header';
    
    if (wp_is_mobile()) {
        $classes[] = 'mobile';
    }
    
    return $classes;
}
add_filter('body_class', 'contentfreaks_body_classes');

/**
 * Cocoon„ÅÆ„Éò„ÉÉ„ÉÄ„Éº„Éª„Éï„ÉÉ„Çø„Éº„ÇíÁÑ°ÂäπÂåñ
 */
function contentfreaks_disable_cocoon_elements() {
    // Cocoon„ÅÆ„Éò„ÉÉ„ÉÄ„ÉºË¶ÅÁ¥†„ÇíÂâäÈô§
    remove_action('wp_head', 'cocoon_header_meta_tags');
    remove_action('cocoon_header', 'cocoon_header_tag');
    
    // Cocoon„ÅÆ„Éá„Éï„Ç©„É´„Éà„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„ÇíÁÑ°ÂäπÂåñ
    add_filter('cocoon_is_header_enable', '__return_false');
    add_filter('cocoon_is_footer_enable', '__return_false');
    add_filter('cocoon_is_mobile_header_enable', '__return_false');
    add_filter('cocoon_is_mobile_footer_enable', '__return_false');
}
add_action('init', 'contentfreaks_disable_cocoon_elements', 1);

/**
 * „ÉÜ„Éº„Éû„Çµ„Éù„Éº„Éà„Å®„É°„Éã„É•„Éº„ÅÆÁôªÈå≤
 */
function contentfreaks_theme_setup() {
    // „Ç´„Çπ„Çø„É†„É°„Éã„É•„Éº„ÅÆ„Çµ„Éù„Éº„Éà„ÇíËøΩÂä†
    add_theme_support('menus');
    
    // „É°„Éã„É•„Éº„ÅÆÂ†¥ÊâÄ„ÇíÁôªÈå≤
    register_nav_menus(array(
        'primary' => '„Éó„É©„Ç§„Éû„É™„É°„Éã„É•„Éº',
        'header' => '„Éò„ÉÉ„ÉÄ„Éº„É°„Éã„É•„Éº',
        'footer' => '„Éï„ÉÉ„Çø„Éº„É°„Éã„É•„Éº',
    ));
}
add_action('after_setup_theme', 'contentfreaks_theme_setup');

/**
 * „Éö„Éº„Ç∏„ÅÆURL„ÇíÂèñÂæó„Åô„Çã„Éò„É´„Éë„ÉºÈñ¢Êï∞
 */
function contentfreaks_get_page_url($slug) {
    $page = get_page_by_path($slug);
    if ($page) {
        return get_permalink($page->ID);
    }
    return home_url('/' . $slug . '/');
}

/**
 * ÂøÖË¶Å„Å™„Éö„Éº„Ç∏„ÅåÂ≠òÂú®„Åô„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ„Åó„ÄÅ„Å™„Åë„Çå„Å∞‰ΩúÊàê„Åô„Çã
 */
function contentfreaks_create_pages() {
    $pages = array(
        'blog' => array(
            'title' => '„Éñ„É≠„Ç∞',
            'template' => 'page-blog.php'
        ),
        'episodes' => array(
            'title' => '„Ç®„Éî„ÇΩ„Éº„Éâ',
            'template' => 'page-episodes.php'
        ),
        'profile' => array(
            'title' => '„Éó„É≠„Éï„Ç£„Éº„É´',
            'template' => 'page-profile.php'
        ),
        'history' => array(
            'title' => 'Ê≠¥Âè≤',
            'template' => 'page-history.php'
        )
    );
    
    foreach ($pages as $slug => $page_data) {
        $existing_page = get_page_by_path($slug);
        if (!$existing_page) {
            $page_id = wp_insert_post(array(
                'post_title' => $page_data['title'],
                'post_name' => $slug,
                'post_status' => 'publish',
                'post_type' => 'page'
            ));
            
            if ($page_id && !is_wp_error($page_id)) {
                update_post_meta($page_id, '_wp_page_template', $page_data['template']);
            }
        }
    }
}
add_action('init', 'contentfreaks_create_pages');

/**
 * „ÇØ„Ç®„É™Â§âÊï∞„ÇíËøΩÂä†
 */
function contentfreaks_add_query_vars($vars) {
    $vars[] = 'episodes';
    return $vars;
}
add_filter('query_vars', 'contentfreaks_add_query_vars');

/**
 * „ÉÜ„É≥„Éó„É¨„Éº„ÉàË™≠„ÅøËæº„Åø
 */
function contentfreaks_template_include($template) {
    if (get_query_var('episodes')) {
        $episodes_template = get_stylesheet_directory() . '/archive-episodes.php';
        if (file_exists($episodes_template)) {
            return $episodes_template;
        }
    }
    return $template;
}
add_filter('template_include', 'contentfreaks_template_include');

/**
 * „É™„É©„Ç§„Éà„É´„Éº„É´„ÇíÂàùÊúüÂåñÔºà„ÉÜ„Éº„ÉûÊúâÂäπÂåñÊôÇÔºâ
 */
function contentfreaks_flush_rewrite_rules() {
    contentfreaks_add_rewrite_rules();
    flush_rewrite_rules();
}
register_activation_hook(__FILE__, 'contentfreaks_flush_rewrite_rules');

/**
 * „É™„É©„Ç§„Éà„É´„Éº„É´„ÇíÂº∑Âà∂„Éï„É©„ÉÉ„Ç∑„É•Ôºà„Éá„Éê„ÉÉ„Ç∞Áî®Ôºâ
 * Ê≥®ÊÑè: Êú¨Áï™Áí∞Â¢É„Åß„ÅØ‰ΩøÁî®„Åó„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ
 */
function contentfreaks_force_flush_rewrite_rules() {
    // URL„Éë„É©„É°„Éº„Çø„Åß„É™„É©„Ç§„Éà„É´„Éº„É´„Çí„Éï„É©„ÉÉ„Ç∑„É•
    if (isset($_GET['flush_rewrite']) && $_GET['flush_rewrite'] === 'contentfreaks' && current_user_can('manage_options')) {
        contentfreaks_add_rewrite_rules();
        flush_rewrite_rules();
        wp_redirect(remove_query_arg('flush_rewrite'));
        exit;
    }
}
add_action('init', 'contentfreaks_force_flush_rewrite_rules');

/**
 * CSSË™≠„ÅøËæº„ÅøÁä∂Ê≥Å„Çí„Éá„Éê„ÉÉ„Ç∞ÔºàÈñãÁô∫Áí∞Â¢É„ÅÆ„ÅøÔºâ
 */
function contentfreaks_css_debug() {
    // ÈñãÁô∫Áí∞Â¢É„Åæ„Åü„ÅØWP_DEBUG„ÅåÊúâÂäπ„Å™Â†¥Âêà„ÅÆ„ÅøÂÆüË°å
    if (!defined('WP_DEBUG') || !WP_DEBUG) {
        return;
    }
    
    echo "<!-- ContentFreaks CSS Debug Info -->\n";
    echo "<script>\n";
    echo "console.log('ContentFreaks CSS Debug:');\n";
    echo "console.log('Theme Directory:', '" . get_stylesheet_directory_uri() . "');\n";
    echo "console.log('CSS Files:');\n";
    echo "console.log('1. Cocoon Style:', '" . get_template_directory_uri() . "/style.css');\n";
    echo "console.log('2. Child Main:', '" . get_stylesheet_directory_uri() . "/style.css');\n";
    echo "console.log('3. ContentFreaks Final:', '" . get_stylesheet_directory_uri() . "/contentfreaks-final.css');\n";
    
    // CSS„Éï„Ç°„Ç§„É´„ÅÆÂ≠òÂú®Á¢∫Ë™ç
    $css_files = array(
        'style.css' => get_stylesheet_directory() . '/style.css',
        'contentfreaks-final.css' => get_stylesheet_directory() . '/contentfreaks-final.css'
    );
    
    foreach ($css_files as $name => $path) {
        $exists = file_exists($path) ? 'EXISTS' : 'MISSING';
        $size = file_exists($path) ? filesize($path) : 0;
        echo "console.log('$name: $exists ($size bytes)');\n";
    }
    
    echo "</script>\n";
    echo "<!-- End ContentFreaks CSS Debug -->\n";
}
add_action('wp_head', 'contentfreaks_css_debug');

/**
 * Cocoon„ÅÆÁ´∂Âêà„Åô„Çã„Çπ„Çø„Ç§„É´„ÇíÁÑ°ÂäπÂåñ
 */
function contentfreaks_disable_conflicting_styles() {
    // Cocoon„ÅÆ‰∏ÄÈÉ®„Çπ„Çø„Ç§„É´„ÇíÁÑ°ÂäπÂåñ„Åó„Å¶ContentFreaksÂ∞ÇÁî®„Çπ„Çø„Ç§„É´„ÇíÂÑ™ÂÖà
    wp_dequeue_style('cocoon-child-style'); // Â≠ê„ÉÜ„Éº„Éû„ÅÆËá™ÂãïË™≠„ÅøËæº„Åø„ÇíÁÑ°ÂäπÂåñ
    
    // Cocoon„ÅÆ„Éò„ÉÉ„ÉÄ„ÉºÈñ¢ÈÄ£CSS„ÇíÁÑ°ÂäπÂåñ
    add_filter('cocoon_header_style_enable', '__return_false');
    add_filter('cocoon_header_layout_enable', '__return_false');
}
add_action('wp_enqueue_scripts', 'contentfreaks_disable_conflicting_styles', 5);

/**
 * ContentFreaksÂ∞ÇÁî®„ÅÆ„Éú„Éá„Ç£„ÇØ„É©„Çπ„ÇíËøΩÂä†
 */
function contentfreaks_enhanced_body_class($classes) {
    $classes[] = 'contentfreaks-custom-header';
    $classes[] = 'has-contentfreaks-header';
    
    // „É¢„Éê„Ç§„É´Âà§ÂÆö
    if (wp_is_mobile()) {
        $classes[] = 'mobile';
    }
    
    return $classes;
}
add_filter('body_class', 'contentfreaks_enhanced_body_class');
